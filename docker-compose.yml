version: '3.8'

# Docker Compose untuk local development dengan Cloud SQL Proxy
# Usage: docker-compose -f docker-compose.cloudsql.yml up
#
# Setup terpisah:
# - cloud-sql-proxy: Container untuk koneksi ke GCP Cloud SQL
# - pgadmin: Database management UI (port 5050)
# - api: FastAPI backend (port 8000) + GCS integration

services:
  cloud-sql-proxy:
    image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.18.2
    container_name: system-llm-cloud-sql-proxy
    networks:
      - system-llm-network
    command:
      - "system-llm:asia-southeast2:system-llm-db"
      - "--address=0.0.0.0"
      - "--port=5432"
    ports:
      - "5432:5432"
    volumes:
      # Mount gcloud credentials dari host ke container
      # Path host: C:\Users\pcgsa\AppData\Roaming\gcloud\application_default_credentials.json
      # Path container: /credentials.json
      - "C:\\Users\\pcgsa\\AppData\\Roaming\\gcloud\\application_default_credentials.json:/credentials.json:ro"
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: /credentials.json

  pgadmin:
    image: dpage/pgadmin4
    container_name: system-llm-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@admin.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
    ports:
      - "5050:80"
    depends_on:
      - cloud-sql-proxy
    networks:
      - system-llm-network
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: system-llm-api
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - /app/logs
      # Mount gcloud credentials dari host ke container
      - "C:\\Users\\pcgsa\\AppData\\Roaming\\gcloud\\application_default_credentials.json:/credentials.json:ro"
      # Mount GCS credentials
      - ./system-llm-storage-key.json:/app/credentials/system-llm-storage-key.json:ro
    env_file:
      - .env
    environment:
      # Connect ke Cloud SQL Proxy (hostname: cloud-sql-proxy di docker network)
      - DATABASE_URL=postgresql://llm_user:anLLMUser123123@cloud-sql-proxy:5432/system_llm
      - SECRET_KEY=${SECRET_KEY}
      - ALGORITHM=${ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-1440}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - POSTGRES_USER=llm_user
      - POSTGRES_PASSWORD=anLLMUser123123
      - POSTGRES_DB=system_llm
      - PROJECT_NAME=${PROJECT_NAME:-System LLM}
      - API_V1_PREFIX=${API_V1_PREFIX:-/api/v1}
      - DEBUG=${DEBUG:-True}
      - BACKEND_CORS_ORIGINS=${BACKEND_CORS_ORIGINS:-["http://localhost:3000","http://localhost:3001","http://localhost:8000"]}
      - CLOUD_SQL_INSTANCES=system-llm:asia-southeast2:system-llm-db
      # Point to credentials file di dalam container (sudah di-mount)
      - GOOGLE_APPLICATION_CREDENTIALS=/credentials.json
      # GCS Configuration
      - STORAGE_TYPE=gcs
      - GCS_BUCKET_NAME=${GCS_BUCKET_NAME}
      - GCS_PROJECT_ID=${GCS_PROJECT_ID}
      - GCS_CREDENTIALS_PATH=/app/credentials/system-llm-storage-key.json
    depends_on:
      - cloud-sql-proxy
    networks:
      - system-llm-network
    restart: unless-stopped

networks:
  system-llm-network:
    driver: bridge
